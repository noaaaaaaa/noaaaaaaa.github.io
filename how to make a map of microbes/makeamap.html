<!DOCTYPE html>
<html>
<head>
<title>first.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="how-to-make-a-map-of-microbes">how to make a map of microbes</h1>
<h2 id="1">1</h2>
<p>After obtaining the results from IMNGS, open any <code>.tab</code> file. The first column would be <code>Sample_Name</code>, which represents the run number of the SRA that aligned to the provided 16S rRNA sequences.</p>
<p>For example, this is an outcome from IMNGS.</p>
<p><img src="./图片1.png" alt="test"></p>
<h2 id="2">2</h2>
<p>Each run number could be searched in public database (e.g. <a href="http://ncbi.nlm.nih.gov" title="http://ncbi.nlm.nih.gov">NCBI</a>). If we search the run <a href="http://ncbi.nlm.nih.gov/sra/DRR033766">DRR033766</a> in NCBI, we will enter a webpage like this.</p>
<p><img src="./图片2.png" alt="test"></p>
<h2 id="3">3</h2>
<p>You can see that the website address is in a fixed pattern:</p>
<pre class="hljs"><code><div>https://www.ncbi.nlm.nih.gov/sra/ + run_number
</div></code></pre>
<p>And every run number has an according biosample number. If we enter the biosample webpage, luckily, we can see there’s a coordinate at 'the latitude and longitude' column:</p>
<p><img src="./图片3.png" alt="test"></p>
<h3 id="31">3.1</h3>
<p>However, sometimes we would find no coordinate reported in a sample (see below). Under such condition, I would leave these samples alone.</p>
<p><img src="./图片4.png" alt="test"></p>
<h2 id="4">4</h2>
<p>Alright, this is the overall logic to decide the geographic distribution of our microbes. At first we gather the number of all SRA samples containing our 16S rRNA sequences, and the locations of these samples represent the locations of the microbes. The next question is how to extract so many coordinates from thousands of webpages.</p>
<p>My answer would be web-crawling.</p>
<p>As is shown above, we can download all of the run pages. Make a list of command to download the pages:</p>
<pre class="hljs"><code><div>wget https:<span class="hljs-comment">//www.ncbi.nlm.nih.gov/sra/DRR008621</span>
wget https:<span class="hljs-comment">//www.ncbi.nlm.nih.gov/sra/DRR012999</span>
wget https:<span class="hljs-comment">//www.ncbi.nlm.nih.gov/sra/DRR014145</span>
wget https:<span class="hljs-comment">//www.ncbi.nlm.nih.gov/sra/DRR014487</span>
wget https:<span class="hljs-comment">//www.ncbi.nlm.nih.gov/sra/DRR014501</span>
</div></code></pre>
<p>Here I recommend to put all of the <code>wget</code> command into one file, and use <code>ParaFly</code> or <code>sbatch</code> to run the file. They provide a simple mechanism for running a predefined list of unix commands in parallel using multithreading, which would be much faster than running using singlethreading.</p>
<h2 id="5">5</h2>
<p>Then we should obtain the biosample number within the webpage. Look at the source code of the page. The tags surrounding the biosample number would be like:</p>
<pre class="hljs"><code><div>&lt;a href=<span class="hljs-string">"/biosample/SAMD00015929"</span> title=<span class="hljs-string">"Link to BioSample"</span>&gt;SAMD00015929&lt;<span class="hljs-regexp">/a&gt;
</span></div></code></pre>
<p>And this pair of tags are unique in the page, by which we could locate and extract the biosample number. You can edit an <code>.pl</code> script below using <code>touch extract_biosample.pl</code>, <code>vim extract_biosample.pl</code>, type <code>i</code> to enter the edit mode, and paste the text below:</p>
<pre class="hljs"><code><div><span class="hljs-meta">#!/usr/bin/perl</span>
open(file1,@ARGV[<span class="hljs-number">0</span>]);

<span class="hljs-keyword">while</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">file1</span>&gt;</span>) {
        if ($_ =~ m/Link\sto\sBioSample.*?&gt;(.*?)<span class="hljs-tag">&lt;/<span class="hljs-name">o)</span> {
                <span class="hljs-attr">print</span> $<span class="hljs-attr">1</span>,"\<span class="hljs-attr">n</span>";}
        }
</span></span></div></code></pre>
<h2 id="6">6</h2>
<p>And then, execute the <code>.pl</code> script on the run webpage:</p>
<pre class="hljs"><code><div>./extract_biosample.pl ../webpages/DRR014145 &gt; DRR014145.biosample
</div></code></pre>
<p>We get a single biosample number in the <code>.biosample</code> file. Go through all the run webpages, we now get all the <code>run_number.biosample</code> files:</p>
<p><img src="./图片5.png" alt="test"></p>
<p>Check if the number was extracted by opening one of the files:</p>
<p><img src="./图片6.png" alt="test"></p>
<p>Next, we can merge the run number toward the file using:</p>
<pre class="hljs"><code><div>for i in 'ls *.biosample'; do cat $i | sed 's/^/'$i'\t/' &gt;&gt; test.file; done
</div></code></pre>
<p>Open the <code>test.file</code> to check if the file names are added before the sample numbers. Not every run or biosample has the webpage in NCBI, but the command above have already screened out the unavailable ones. And you can check to make sure the biosample number is accordance with the run number.</p>
<p><img src="./图片7.png" alt="test"></p>
<h2 id="7">7</h2>
<p>Now we have the list of biosample number. Just like the previous step, download all the webpages of the biosamples and then extract the coordinates between the tags.
I still recommend using ParaFly to download these webpages:</p>
<pre class="hljs"><code><div>wget https:<span class="hljs-comment">//www.ncbi.nlm.nih.gov/biosample/SAMD00028966</span>
wget https:<span class="hljs-comment">//www.ncbi.nlm.nih.gov/biosample/SAMD00013029</span>
…
</div></code></pre>
<p>Pick different biosample web webpages to check out. You might find different situations:</p>
<ol>
<li>There might be no coordinates;</li>
<li>The coordinates are surrounded by a pair of google map tags;</li>
<li>The longitude and latitude are placed separately;</li>
<li>The longitude and latitude are placed together.</li>
</ol>
<p>We have nothing to do with the first situation. For the rest of the situations, we can use the following <code>.pl</code> script to extract the coordinates:</p>
<pre class="hljs"><code><div><span class="hljs-comment">#!/usr/bin/perl</span>
open(file1,@ARGV[<span class="hljs-number">0</span>]);
<span class="hljs-keyword">while</span> (&lt;file1&gt;) {
        <span class="hljs-keyword">if</span> ($_ =~ m/www.google.com\/maps\/place\/.*?&gt;(.*?)&lt;/o) {
                <span class="hljs-keyword">print</span> $<span class="hljs-number">1</span>,<span class="hljs-string">"\n"</span>;}
        } 

</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">#!/usr/bin/perl</span>
open(file1,@ARGV[<span class="hljs-number">0</span>]);
<span class="hljs-keyword">while</span> (&lt;file1&gt;) {
        <span class="hljs-keyword">if</span> ($_ =~ m/latitude.*?td&gt;(.*?)&lt;.*?longitude.*?td&gt;(.*?)&lt;/o) {
                <span class="hljs-keyword">print</span> $<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>,<span class="hljs-string">"\n"</span>;}
        }

</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">#!/usr/bin/perl</span>
open(file1,@ARGV[<span class="hljs-number">0</span>]);
<span class="hljs-keyword">while</span> (&lt;file1&gt;) {
        <span class="hljs-keyword">if</span> ($_ =~ m/latitude <span class="hljs-keyword">and</span> longitude.*?td&gt;(.*?)&lt;/o) {
                <span class="hljs-keyword">print</span> $<span class="hljs-number">1</span>,<span class="hljs-string">"\n"</span>;}
        }

</div></code></pre>
<p>And then, execute the .pl script on the biosample webpage:</p>
<pre class="hljs"><code><div>./extract_coordinates.pl ../webpages/SAMD00013029 &gt; SAMD00013029.coordinates
</div></code></pre>
<p>Remember, try to resolve each of the situation one by one, and pick out the null file (might not suit the situation) before doing the next. After extracting all of the coordinates (clean all of the null files before the next step), you can merge the biosample number toward the file using:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-string">'ls *.coordinates'</span>; do cat $i | sed <span class="hljs-string">'s/^/'</span>$i<span class="hljs-string">'\t/'</span> &gt;&gt; coordinates.file; done
</div></code></pre>
<h2 id="8">8</h2>
<p>And finally you have a file with biosample number and its coordinates. However, the coordinates are not in the same form and sometime even mistakenly wrote. My method was to output the coordinates.file into excel and correct them manually into unified form like:</p>
<p><img src="./图片8.png" alt="test"></p>
<h2 id="9">9</h2>
<p>The final step is to plot the coordinates on a map. I used the software <code>tableau</code> to do so, it’s quite convenient and user friendly, you can apply for a 14-day trial for free.</p>
<p><img src="./图片9.png" alt="test"></p>
<h1 id="finished">Finished!</h1>

</body>
</html>
